const sdk = require('node-appwrite');
const { handleRequest } = require('@kaibun/appwrite-fn-router');

const { ID } = sdk;

export default async function main(context) {
  const client = new sdk.Client()
    .setEndpoint(process.env.APPWRITE_ENDPOINT)
    .setProject(process.env.APPWRITE_PROJECT_ID)
    .setKey(process.env.APPWRITE_API_KEY);

  const databases = new sdk.Databases(client);

  return await handleRequest(context, (router) => {
    // GET /widgets
    router.get('/widgets', async (_req, res) => {
      const result = await databases.listDocuments(
        process.env.APPWRITE_DATABASE_ID,
        process.env.APPWRITE_COLLECTION_ID
      );
      return res.json({ items: result.documents });
    });

    // POST /widgets
    router.post('/widgets', async (req, res) => {
      const widget = req.body;
      const created = await databases.createDocument(
        process.env.APPWRITE_DATABASE_ID,
        process.env.APPWRITE_COLLECTION_ID,
        ID.unique(),
        widget
      );
      return res.json(created, 201);
    });
  });
}
